
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit & Loss Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        h1 { color: #1e293b; font-size: 2.5rem; margin-bottom: 0.5rem; }
        .subtitle { color: #64748b; margin-bottom: 2rem; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 1rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-group { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .filter-bar { background: white; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 2rem; }
        .filter-bar select, .filter-bar input { padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 1rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.07); }
        .stat-card.profit { border-left: 4px solid #10b981; }
        .stat-card.loss { border-left: 4px solid #ef4444; }
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .stat-label { color: #64748b; font-weight: 500; }
        .stat-value { font-size: 2rem; font-weight: bold; }
        .stat-value.income { color: #10b981; }
        .stat-value.expense { color: #ef4444; }
        .stat-value.profit { color: #10b981; }
        .stat-value.loss { color: #ef4444; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .chart-card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.07); }
        .chart-title { font-size: 1.25rem; font-weight: bold; color: #1e293b; margin-bottom: 1rem; }
        .breakdown-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .breakdown-card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.07); }
        .breakdown-item { display: flex; justify-content: space-between; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; }
        .breakdown-item.income { background: #f0fdf4; }
        .breakdown-item.expense { background: #fef2f2; }
        .breakdown-item .name { font-weight: 500; color: #334155; }
        .breakdown-item .value { font-weight: bold; }
        .breakdown-item.income .value { color: #10b981; }
        .breakdown-item.expense .value { color: #ef4444; }
        .table-card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.07); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 0.75rem 1rem; color: #475569; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
        td { padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; }
        tr:hover { background: #f8fafc; }
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
        .badge.income { background: #d1fae5; color: #065f46; }
        .badge.expense { background: #fee2e2; color: #991b1b; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: bold; color: #1e293b; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #475569; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 1rem; }
        .category-list { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem; }
        .category-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.5rem; }
        .category-item.income { background: #f0fdf4; }
        .category-item.expense { background: #fef2f2; }
        .delete-btn { background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem; }
        .empty-state { text-align: center; padding: 3rem; color: #94a3b8; }
        .icon { width: 24px; height: 24px; }
        @media (max-width: 768px) {
            .charts-grid, .breakdown-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: stretch; }
            table { font-size: 0.875rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>Profit & Loss Dashboard</h1>
                <p class="subtitle">Track your business performance with detailed analytics</p>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="showImportExport()">
                    <span>üì¶</span> Backup
                </button>
                <button class="btn btn-secondary" onclick="showSettings()">
                    <span>‚öôÔ∏è</span> Categories
                </button>
                <button class="btn btn-primary" onclick="showAddTransaction()">
                    <span>‚ûï</span> Add Transaction
                </button>
            </div>
        </div>

        <div class="filter-bar">
            <span style="color: #475569; font-weight: 500;">üîç Period:</span>
            <select id="periodFilter" onchange="handlePeriodChange()">
                <option value="all">All Time</option>
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
                <option value="specific-month">Specific Month</option>
                <option value="custom">Custom Range</option>
            </select>
            <select id="monthSelector" style="display:none;" onchange="handleMonthChange()">
                <option value="">Select Month</option>
            </select>
            <select id="commissionRunSelector" style="display:none;" onchange="applyFilter()">
                <option value="whole">Whole Month</option>
                <option value="first">1st Commission Run (1st-15th)</option>
                <option value="second">2nd Commission Run (16th-End)</option>
            </select>
            <input type="date" id="startDate" style="display:none;" onchange="applyFilter()">
            <span id="dateSeparator" style="display:none;">to</span>
            <input type="date" id="endDate" style="display:none;" onchange="applyFilter()">
            <button class="btn btn-secondary" onclick="showFilters()" style="margin-left: auto;">
                <span>üéØ</span> Advanced Filters
            </button>
        </div>

        <div id="advancedFilters" style="display: none; background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem;">Filter Transactions</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Type</label>
                    <select id="filterType" onchange="updateFilterMainCategories(); applyFilter();" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;">
                        <option value="all">All Types</option>
                        <option value="income">Income Only</option>
                        <option value="expense">Expense Only</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Main Category</label>
                    <select id="filterCategory" onchange="updateFilterSubcategory1(); applyFilter();" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Subcategory 1</label>
                    <select id="filterSubcategory1" onchange="updateFilterSubcategory2(); applyFilter();" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;">
                        <option value="all">All Subcategories</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Subcategory 2</label>
                    <select id="filterSubcategory2" onchange="applyFilter()" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;">
                        <option value="all">All Subcategories</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Advisor</label>
                    <select id="filterAdvisor" onchange="applyFilter()" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;">
                        <option value="all">All Advisors</option>
                    </select>
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-secondary" onclick="resetFilters()" style="width: 100%;">
                        <span>üîÑ</span> Reset Filters
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Total Income</span>
                    <span>üìà</span>
                </div>
                <div class="stat-value income" id="totalIncome">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">Total Expenses</span>
                    <span>üìâ</span>
                </div>
                <div class="stat-value expense" id="totalExpenses">$0</div>
            </div>
            <div class="stat-card" id="profitCard">
                <div class="stat-header">
                    <span class="stat-label">Net Profit/Loss</span>
                    <span>üí∞</span>
                </div>
                <div class="stat-value" id="netProfit">$0</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Monthly Trend</h3>
                <canvas id="monthlyChart"></canvas>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Income vs Expenses</h3>
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>

        <div class="breakdown-grid">
            <div class="breakdown-card">
                <h3 class="chart-title">Income Breakdown</h3>
                <div id="incomeBreakdown" class="category-list"></div>
            </div>
            <div class="breakdown-card">
                <h3 class="chart-title">Expense Breakdown</h3>
                <div id="expenseBreakdown" class="category-list"></div>
            </div>
        </div>

        <div class="table-card">
            <h3 class="chart-title">Recent Transactions</h3>
            <table id="transactionsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th style="text-align: right;">Amount</th>
                        <th style="text-align: right;">Action</th>
                    </tr>
                </thead>
                <tbody id="transactionsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="transactionModalTitle">Add Transaction</h2>
                <button class="close-btn" onclick="closeModal('addTransactionModal')">&times;</button>
            </div>
            <form onsubmit="saveTransaction(event)">
                <div class="form-group">
                    <label>Type</label>
                    <select id="transactionType" onchange="updateCategoryOptions()">
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Main Category</label>
                    <select id="transactionCategory" onchange="updateSubcategory1Options()" required></select>
                </div>
                <div class="form-group">
                    <label>Subcategory 1</label>
                    <select id="transactionSubcategory1" onchange="updateSubcategory2Options()" required></select>
                </div>
                <div class="form-group">
                    <label>Description (Subcategory 2)</label>
                    <select id="transactionSubcategory2" required></select>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="transactionAmount" step="0.01" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Advisor</label>
                    <select id="transactionAdvisor" required>
                        <option value="">Select advisor</option>
                    </select>
                    <button type="button" onclick="showManageAdvisors()" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: #64748b; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem;">
                        Manage Advisors
                    </button>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="transactionDate" required>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="transactionRecurring" onchange="toggleRecurringOptions()">
                        <span>Set as Recurring Transaction</span>
                    </label>
                </div>
                <div id="recurringOptions" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                    <div class="form-group">
                        <label>Frequency</label>
                        <select id="recurringFrequency">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="biweekly">Bi-weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>End Date (optional)</label>
                        <input type="date" id="recurringEndDate">
                        <small style="color: #64748b; font-size: 0.75rem;">Leave empty for indefinite recurring</small>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span id="saveButtonText">Add Transaction</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Manage Categories</h2>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Add New Category</label>
                <div style="display: grid; grid-template-columns: auto 1fr 1fr 1fr 1fr auto; gap: 0.5rem; align-items: end;">
                    <select id="newCategoryType" style="padding: 0.75rem;">
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                    <div>
                        <label style="font-size: 0.75rem; color: #64748b;">Main Category</label>
                        <input type="text" id="newCategoryName" placeholder="e.g., Sales" style="width: 100%;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: #64748b;">Sub 1 Name</label>
                        <input type="text" id="newSub1Name" placeholder="e.g., Products" style="width: 100%;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: #64748b;">Sub 2 Options</label>
                        <input type="text" id="newSub1Sub2_1" placeholder="e.g., Physical" style="width: 100%;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: #64748b;">&nbsp;</label>
                        <input type="text" id="newSub1Sub2_2" placeholder="e.g., Digital" style="width: 100%;">
                    </div>
                    <button class="btn btn-primary" onclick="addCategoryRow1()" style="height: fit-content;">+</button>
                </div>
                <div id="secondSubRow" style="display: none; margin-top: 0.5rem;">
                    <div style="display: grid; grid-template-columns: auto 1fr 1fr 1fr 1fr auto; gap: 0.5rem; align-items: end;">
                        <div style="width: 100px;"></div>
                        <div style="color: #94a3b8; font-size: 0.875rem; padding: 0.75rem;">‚Ü≥ Same Main</div>
                        <div>
                            <label style="font-size: 0.75rem; color: #64748b;">Sub 1 Name</label>
                            <input type="text" id="newSub2Name" placeholder="e.g., Services" style="width: 100%;">
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; color: #64748b;">Sub 2 Options</label>
                            <input type="text" id="newSub2Sub2_1" placeholder="e.g., One-time" style="width: 100%;">
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; color: #64748b;">&nbsp;</label>
                            <input type="text" id="newSub2Sub2_2" placeholder="e.g., Recurring" style="width: 100%;">
                        </div>
                        <button class="btn btn-success" onclick="addCategory()" style="height: fit-content;">Save All</button>
                    </div>
                </div>
            </div>
            <div style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">Income Categories</h3>
                <div id="incomeCategoriesList" class="category-list"></div>
            </div>
            <div style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">Expense Categories</h3>
                <div id="expenseCategoriesList" class="category-list"></div>
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div id="importExportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Backup & Restore</h2>
                <button class="close-btn" onclick="closeModal('importExportModal')">&times;</button>
            </div>
            <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <h4 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üíæ</span> Export Data
                </h4>
                <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                    Download all your transactions and categories as a backup file.
                </p>
                <button class="btn btn-success" onclick="exportData()" style="width: 100%;">
                    <span>‚¨áÔ∏è</span> Download Backup File
                </button>
                <p id="exportCount" style="color: #64748b; font-size: 0.75rem; text-align: center; margin-top: 0.5rem;"></p>
            </div>
            <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <h4 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üìÅ</span> Import Data
                </h4>
                <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                    Restore your data from a previously exported backup file.
                </p>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn btn-primary" onclick="document.getElementById('importFile').click()" style="width: 100%;">
                    <span>‚¨ÜÔ∏è</span> Choose Backup File
                </button>
                <p id="importWarning" style="color: #f59e0b; font-size: 0.75rem; text-align: center; margin-top: 0.5rem; font-weight: 500;"></p>
            </div>
            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 1rem;">
                <h5 style="color: #1e40af; font-size: 0.875rem; margin-bottom: 0.5rem;">üí° Tips</h5>
                <ul style="color: #1e40af; font-size: 0.75rem; padding-left: 1.5rem;">
                    <li>Export regularly to keep backups of your data</li>
                    <li>Use export to transfer data between devices</li>
                    <li>Store backup files in a safe location</li>
                    <li>File name includes the date for easy organization</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editCategoryModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Edit Category</h2>
                <button class="close-btn" onclick="closeModal('editCategoryModal')">&times;</button>
            </div>
            <form onsubmit="saveEditedCategory(event)">
                <input type="hidden" id="editCategoryType">
                <input type="hidden" id="editCategoryOriginalName">
                
                <div class="form-group">
                    <label>Main Category Name</label>
                    <input type="text" id="editCategoryName" required style="width: 100%;">
                </div>

                <div style="margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Subcategories</h4>
                    <div id="editSubcategoriesList"></div>
                    <button type="button" class="btn btn-secondary" onclick="addEditSubcategory()" style="margin-top: 1rem;">
                        <span>‚ûï</span> Add Subcategory Level 1
                    </button>
                </div>

                <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editCategoryModal')" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Advisors Modal -->
    <div id="manageAdvisorsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Manage Advisors</h2>
                <button class="close-btn" onclick="closeModal('manageAdvisorsModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Add New Advisor</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="newAdvisorName" placeholder="Advisor name" style="flex: 1;">
                    <button class="btn btn-primary" onclick="addAdvisor()">Add</button>
                </div>
            </div>
            <div style="margin-top: 2rem;">
                <h4 style="margin-bottom: 1rem;">Current Advisors</h4>
                <div id="advisorsList" class="category-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let transactions = [];
        let advisors = ['John Smith', 'Jane Doe', 'Michael Johnson'];
        let incomeCategories = [
            { 
                name: 'Sales', 
                subcategories: [
                    { name: 'Product Sales', subcategories: ['Physical Products', 'Digital Products'] },
                    { name: 'Service Sales', subcategories: ['One-time Services', 'Recurring Services'] }
                ]
            },
            { 
                name: 'Services', 
                subcategories: [
                    { name: 'Consulting', subcategories: ['Hourly Consulting', 'Project Consulting'] },
                    { name: 'Maintenance', subcategories: ['Regular Maintenance', 'Emergency Repairs'] }
                ]
            },
            { 
                name: 'Other Income', 
                subcategories: [
                    { name: 'Interest', subcategories: ['Savings Interest', 'Investment Returns'] },
                    { name: 'Refunds', subcategories: ['Tax Refunds', 'Vendor Refunds'] }
                ]
            }
        ];
        let expenseCategories = [
            { 
                name: 'Cost of Goods Sold', 
                subcategories: [
                    { name: 'Materials', subcategories: ['Raw Materials', 'Packaging'] },
                    { name: 'Direct Labor', subcategories: ['Production Staff', 'Contract Workers'] }
                ]
            },
            { 
                name: 'Payroll', 
                subcategories: [
                    { name: 'Salaries', subcategories: ['Full-time', 'Part-time'] },
                    { name: 'Benefits', subcategories: ['Health Insurance', 'Retirement'] }
                ]
            },
            { 
                name: 'Rent', 
                subcategories: [
                    { name: 'Office Rent', subcategories: ['Monthly Rent', 'Common Area Fees'] },
                    { name: 'Equipment Rent', subcategories: ['Machinery', 'Vehicles'] }
                ]
            },
            { 
                name: 'Utilities', 
                subcategories: [
                    { name: 'Electric', subcategories: ['Office Electric', 'Production Electric'] },
                    { name: 'Internet', subcategories: ['Office Internet', 'Cloud Services'] }
                ]
            },
            { 
                name: 'Marketing', 
                subcategories: [
                    { name: 'Advertising', subcategories: ['Online Ads', 'Print Ads'] },
                    { name: 'Events', subcategories: ['Trade Shows', 'Networking Events'] }
                ]
            },
            { 
                name: 'Software/Subscriptions', 
                subcategories: [
                    { name: 'Software', subcategories: ['Design Software', 'Office Software'] },
                    { name: 'SaaS', subcategories: ['CRM', 'Accounting'] }
                ]
            },
            { 
                name: 'Office Supplies', 
                subcategories: [
                    { name: 'Supplies', subcategories: ['Stationery', 'Printer Supplies'] },
                    { name: 'Equipment', subcategories: ['Computers', 'Furniture'] }
                ]
            },
            { 
                name: 'Professional Services', 
                subcategories: [
                    { name: 'Legal', subcategories: ['Business Law', 'Contract Review'] },
                    { name: 'Accounting', subcategories: ['Bookkeeping', 'Tax Preparation'] }
                ]
            },
            { 
                name: 'Insurance', 
                subcategories: [
                    { name: 'Business', subcategories: ['Liability', 'Property'] },
                    { name: 'Health', subcategories: ['Employee Health', 'Dental'] }
                ]
            },
            { 
                name: 'Travel', 
                subcategories: [
                    { name: 'Airfare', subcategories: ['Domestic', 'International'] },
                    { name: 'Lodging', subcategories: ['Hotels', 'Rental Properties'] }
                ]
            },
            { 
                name: 'Miscellaneous', 
                subcategories: [
                    { name: 'Other', subcategories: ['Bank Fees', 'Licenses'] },
                    { name: 'General', subcategories: ['Petty Cash', 'Miscellaneous'] }
                ]
            }
        ];
        let charts = {};
        let editingTransactionId = null;

        // Load data from localStorage
        function loadData() {
            try {
                const txData = localStorage.getItem('pl_transactions');
                const incData = localStorage.getItem('pl_income_categories');
                const expData = localStorage.getItem('pl_expense_categories');
                const advisorData = localStorage.getItem('pl_advisors');
                
                if (txData) transactions = JSON.parse(txData);
                if (incData) incomeCategories = JSON.parse(incData);
                if (expData) expenseCategories = JSON.parse(expData);
                if (advisorData) advisors = JSON.parse(advisorData);
                
                // Migrate old flat structure to new hierarchical structure
                incomeCategories = incomeCategories.map(cat => {
                    if (typeof cat === 'string') {
                        return { 
                            name: cat, 
                            subcategories: [
                                { name: 'General', subcategories: ['Type A', 'Type B'] }
                            ]
                        };
                    } else if (cat.subcategories && cat.subcategories.length > 0 && typeof cat.subcategories[0] === 'string') {
                        // Old two-level structure
                        return {
                            name: cat.name,
                            subcategories: cat.subcategories.map(sub => ({
                                name: sub,
                                subcategories: ['Option 1', 'Option 2']
                            }))
                        };
                    }
                    return cat;
                });
                
                expenseCategories = expenseCategories.map(cat => {
                    if (typeof cat === 'string') {
                        return { 
                            name: cat, 
                            subcategories: [
                                { name: 'General', subcategories: ['Type A', 'Type B'] }
                            ]
                        };
                    } else if (cat.subcategories && cat.subcategories.length > 0 && typeof cat.subcategories[0] === 'string') {
                        // Old two-level structure
                        return {
                            name: cat.name,
                            subcategories: cat.subcategories.map(sub => ({
                                name: sub,
                                subcategories: ['Option 1', 'Option 2']
                            }))
                        };
                    }
                    return cat;
                });
                
                // Add subcategories to old transactions
                transactions = transactions.map(t => {
                    if (!t.subcategory1) {
                        t.subcategory1 = 'General';
                    }
                    if (!t.subcategory2) {
                        t.subcategory2 = 'Type A';
                    }
                    if (!t.advisor) {
                        t.advisor = advisors[0] || 'Unassigned';
                    }
                    return t;
                });
                
                saveData();
            } catch (error) {
                console.log('Starting fresh');
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('pl_transactions', JSON.stringify(transactions));
            localStorage.setItem('pl_income_categories', JSON.stringify(incomeCategories));
            localStorage.setItem('pl_expense_categories', JSON.stringify(expenseCategories));
            localStorage.setItem('pl_advisors', JSON.stringify(advisors));
        }

        // Process recurring transactions
        function processRecurringTransactions() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const recurringTransactions = transactions.filter(t => t.isRecurring);
            let newTransactionsAdded = false;
            
            recurringTransactions.forEach(recurring => {
                // Check if end date has passed
                if (recurring.recurringEndDate) {
                    const endDate = new Date(recurring.recurringEndDate);
                    endDate.setHours(0, 0, 0, 0);
                    if (today > endDate) return;
                }
                
                // Start from the recurring template's original date
                let currentDate = new Date(recurring.date);
                currentDate.setHours(0, 0, 0, 0);
                
                // Generate all occurrences up to today
                let occurrencesToCreate = [];
                let safety = 0; // Prevent infinite loops
                
                while (currentDate <= today && safety < 1000) {
                    safety++;
                    
                    // Check if this occurrence already exists (don't duplicate)
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const exists = transactions.some(t => 
                        t.date === dateStr && 
                        t.category === recurring.category && 
                        t.subcategory1 === recurring.subcategory1 &&
                        t.subcategory2 === recurring.subcategory2 &&
                        t.amount === recurring.amount &&
                        t.advisor === recurring.advisor
                    );
                    
                    if (!exists && currentDate < today) {
                        // Don't create for today's date yet (wait until next day)
                        occurrencesToCreate.push(new Date(currentDate));
                    }
                    
                    // Calculate next occurrence
                    switch(recurring.recurringFrequency) {
                        case 'daily':
                            currentDate.setDate(currentDate.getDate() + 1);
                            break;
                        case 'weekly':
                            currentDate.setDate(currentDate.getDate() + 7);
                            break;
                        case 'biweekly':
                            currentDate.setDate(currentDate.getDate() + 14);
                            break;
                        case 'monthly':
                            currentDate.setMonth(currentDate.getMonth() + 1);
                            break;
                        case 'quarterly':
                            currentDate.setMonth(currentDate.getMonth() + 3);
                            break;
                        case 'yearly':
                            currentDate.setFullYear(currentDate.getFullYear() + 1);
                            break;
                    }
                    
                    // Check if we've passed the end date
                    if (recurring.recurringEndDate) {
                        const endDate = new Date(recurring.recurringEndDate);
                        endDate.setHours(0, 0, 0, 0);
                        if (currentDate > endDate) break;
                    }
                }
                
                // Create all missing occurrences
                occurrencesToCreate.forEach((occurrenceDate, index) => {
                    const newTransaction = {
                        type: recurring.type,
                        category: recurring.category,
                        subcategory1: recurring.subcategory1,
                        subcategory2: recurring.subcategory2,
                        advisor: recurring.advisor,
                        amount: recurring.amount,
                        date: occurrenceDate.toISOString().split('T')[0],
                        isRecurring: false, // Instances are not recurring themselves
                        id: Date.now() + Math.random() + index
                    };
                    
                    transactions.push(newTransaction);
                    newTransactionsAdded = true;
                });
            });
            
            if (newTransactionsAdded) {
                saveData();
            }
        }

        // Modal functions
        function showAddTransaction() {
            editingTransactionId = null;
            document.getElementById('transactionModalTitle').textContent = 'Add Transaction';
            document.getElementById('saveButtonText').textContent = 'Add Transaction';
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionType').value = 'income';
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionRecurring').checked = false;
            document.getElementById('recurringOptions').style.display = 'none';
            document.getElementById('recurringFrequency').value = 'monthly';
            document.getElementById('recurringEndDate').value = '';
            updateCategoryOptions();
            updateAdvisorOptions();
            // Set first advisor as default
            if (advisors.length > 0) {
                document.getElementById('transactionAdvisor').value = advisors[0];
            }
            document.getElementById('addTransactionModal').classList.add('active');
        }

        function toggleRecurringOptions() {
            const isChecked = document.getElementById('transactionRecurring').checked;
            document.getElementById('recurringOptions').style.display = isChecked ? 'block' : 'none';
        }

        function duplicateTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;
            
            if (confirm('Create a duplicate of this transaction?')) {
                const duplicate = {
                    ...transaction,
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0] // Set to today's date
                };
                
                transactions.push(duplicate);
                saveData();
                renderDashboard();
                alert('Transaction duplicated successfully!');
            }
        }

        function updateAdvisorOptions() {
            const select = document.getElementById('transactionAdvisor');
            select.innerHTML = '<option value="">Select advisor</option>';
            advisors.forEach(advisor => {
                const option = document.createElement('option');
                option.value = advisor;
                option.textContent = advisor;
                select.appendChild(option);
            });
        }

        function showManageAdvisors() {
            renderAdvisors();
            document.getElementById('manageAdvisorsModal').classList.add('active');
        }

        function renderAdvisors() {
            const list = document.getElementById('advisorsList');
            list.innerHTML = advisors.map(advisor => `
                <div class="category-item" style="background: #eff6ff;">
                    <span>${advisor}</span>
                    <button class="delete-btn" onclick="deleteAdvisor('${advisor}')">‚úï</button>
                </div>
            `).join('');
        }

        function addAdvisor() {
            const name = document.getElementById('newAdvisorName').value.trim();
            if (!name) return;
            if (advisors.includes(name)) {
                alert('This advisor already exists');
                return;
            }
            advisors.push(name);
            saveData();
            document.getElementById('newAdvisorName').value = '';
            renderAdvisors();
            updateFilterAdvisors();
        }

        function deleteAdvisor(advisor) {
            if (confirm(`Are you sure you want to delete advisor "${advisor}"?`)) {
                advisors = advisors.filter(a => a !== advisor);
                saveData();
                renderAdvisors();
                updateFilterAdvisors();
            }
        }

        function updateFilterAdvisors() {
            const select = document.getElementById('filterAdvisor');
            const currentValue = select.value;
            select.innerHTML = '<option value="all">All Advisors</option>';
            advisors.forEach(advisor => {
                const option = document.createElement('option');
                option.value = advisor;
                option.textContent = advisor;
                select.appendChild(option);
            });
            if (currentValue && advisors.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function showEditTransaction(id) {
            editingTransactionId = id;
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;
            
            document.getElementById('transactionModalTitle').textContent = 'Edit Transaction';
            document.getElementById('saveButtonText').textContent = 'Save Changes';
            document.getElementById('transactionType').value = transaction.type;
            updateCategoryOptions();
            document.getElementById('transactionCategory').value = transaction.category;
            updateSubcategory1Options();
            document.getElementById('transactionSubcategory1').value = transaction.subcategory1 || transaction.subcategory || 'General';
            updateSubcategory2Options();
            document.getElementById('transactionSubcategory2').value = transaction.subcategory2 || 'Type A';
            updateAdvisorOptions();
            document.getElementById('transactionAdvisor').value = transaction.advisor || advisors[0] || '';
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionDate').value = transaction.date;
            
            // Handle recurring settings
            document.getElementById('transactionRecurring').checked = transaction.isRecurring || false;
            if (transaction.isRecurring) {
                document.getElementById('recurringOptions').style.display = 'block';
                document.getElementById('recurringFrequency').value = transaction.recurringFrequency || 'monthly';
                document.getElementById('recurringEndDate').value = transaction.recurringEndDate || '';
            } else {
                document.getElementById('recurringOptions').style.display = 'none';
            }
            
            document.getElementById('addTransactionModal').classList.add('active');
        }

        function showSettings() {
            renderCategories();
            document.getElementById('settingsModal').classList.add('active');
        }

        function showImportExport() {
            document.getElementById('exportCount').textContent = transactions.length > 0 ? `${transactions.length} transaction${transactions.length !== 1 ? 's' : ''} will be exported` : '';
            document.getElementById('importWarning').textContent = transactions.length > 0 ? `‚ö†Ô∏è Warning: This will replace your current ${transactions.length} transaction${transactions.length !== 1 ? 's' : ''}` : '';
            document.getElementById('importExportModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            editingTransactionId = null;
        }

        function showFilters() {
            const filtersDiv = document.getElementById('advancedFilters');
            if (filtersDiv.style.display === 'none') {
                filtersDiv.style.display = 'block';
                updateFilterMainCategories();
            } else {
                filtersDiv.style.display = 'none';
            }
        }

        function resetFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterCategory').value = 'all';
            document.getElementById('filterSubcategory1').value = 'all';
            document.getElementById('filterSubcategory2').value = 'all';
            document.getElementById('filterAdvisor').value = 'all';
            updateFilterMainCategories();
            applyFilter();
        }

        function updateFilterMainCategories() {
            const type = document.getElementById('filterType').value;
            const categorySelect = document.getElementById('filterCategory');
            categorySelect.innerHTML = '<option value="all">All Categories</option>';
            
            let categories = [];
            if (type === 'income') {
                categories = incomeCategories;
            } else if (type === 'expense') {
                categories = expenseCategories;
            } else {
                categories = [...incomeCategories, ...expenseCategories];
            }
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });
            
            updateFilterSubcategory1();
        }

        function updateFilterSubcategory1() {
            const category = document.getElementById('filterCategory').value;
            const sub1Select = document.getElementById('filterSubcategory1');
            sub1Select.innerHTML = '<option value="all">All Subcategories</option>';
            
            if (category === 'all') {
                updateFilterSubcategory2();
                return;
            }
            
            const type = document.getElementById('filterType').value;
            let categories = [];
            if (type === 'income') {
                categories = incomeCategories;
            } else if (type === 'expense') {
                categories = expenseCategories;
            } else {
                categories = [...incomeCategories, ...expenseCategories];
            }
            
            const selectedCategory = categories.find(cat => cat.name === category);
            if (selectedCategory && selectedCategory.subcategories) {
                selectedCategory.subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.name;
                    option.textContent = sub.name;
                    sub1Select.appendChild(option);
                });
            }
            
            updateFilterSubcategory2();
        }

        function updateFilterSubcategory2() {
            const category = document.getElementById('filterCategory').value;
            const sub1 = document.getElementById('filterSubcategory1').value;
            const sub2Select = document.getElementById('filterSubcategory2');
            sub2Select.innerHTML = '<option value="all">All Subcategories</option>';
            
            if (category === 'all' || sub1 === 'all') return;
            
            const type = document.getElementById('filterType').value;
            let categories = [];
            if (type === 'income') {
                categories = incomeCategories;
            } else if (type === 'expense') {
                categories = expenseCategories;
            } else {
                categories = [...incomeCategories, ...expenseCategories];
            }
            
            const selectedCategory = categories.find(cat => cat.name === category);
            if (selectedCategory && selectedCategory.subcategories) {
                const selectedSub1 = selectedCategory.subcategories.find(sub => sub.name === sub1);
                if (selectedSub1 && selectedSub1.subcategories) {
                    selectedSub1.subcategories.forEach(sub2 => {
                        const option = document.createElement('option');
                        option.value = sub2;
                        option.textContent = sub2;
                        sub2Select.appendChild(option);
                    });
                }
            }
        }

        // Update category options in transaction form
        function updateCategoryOptions() {
            const type = document.getElementById('transactionType').value;
            const select = document.getElementById('transactionCategory');
            select.innerHTML = '<option value="">Select main category</option>';
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                select.appendChild(option);
            });
            updateSubcategory1Options();
        }

        function updateSubcategory1Options() {
            const type = document.getElementById('transactionType').value;
            const category = document.getElementById('transactionCategory').value;
            const select = document.getElementById('transactionSubcategory1');
            select.innerHTML = '<option value="">Select subcategory 1</option>';
            
            if (!category) {
                updateSubcategory2Options();
                return;
            }
            
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            const selectedCategory = categories.find(cat => cat.name === category);
            
            if (selectedCategory && selectedCategory.subcategories) {
                selectedCategory.subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.name;
                    option.textContent = sub.name;
                    select.appendChild(option);
                });
            }
            
            updateSubcategory2Options();
        }

        function updateSubcategory2Options() {
            const type = document.getElementById('transactionType').value;
            const category = document.getElementById('transactionCategory').value;
            const sub1 = document.getElementById('transactionSubcategory1').value;
            const select = document.getElementById('transactionSubcategory2');
            select.innerHTML = '<option value="">Select subcategory 2</option>';
            
            if (!category || !sub1) return;
            
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            const selectedCategory = categories.find(cat => cat.name === category);
            
            if (selectedCategory && selectedCategory.subcategories) {
                const selectedSub1 = selectedCategory.subcategories.find(sub => sub.name === sub1);
                if (selectedSub1 && selectedSub1.subcategories) {
                    selectedSub1.subcategories.forEach(sub2 => {
                        const option = document.createElement('option');
                        option.value = sub2;
                        option.textContent = sub2;
                        select.appendChild(option);
                    });
                }
            }
        }

        // Save transaction (add or edit)
        function saveTransaction(event) {
            event.preventDefault();
            
            const isRecurring = document.getElementById('transactionRecurring').checked;
            
            const transaction = {
                type: document.getElementById('transactionType').value,
                category: document.getElementById('transactionCategory').value,
                subcategory1: document.getElementById('transactionSubcategory1').value,
                subcategory2: document.getElementById('transactionSubcategory2').value,
                advisor: document.getElementById('transactionAdvisor').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                date: document.getElementById('transactionDate').value,
                isRecurring: isRecurring
            };
            
            if (isRecurring) {
                transaction.recurringFrequency = document.getElementById('recurringFrequency').value;
                transaction.recurringEndDate = document.getElementById('recurringEndDate').value;
            }
            
            if (editingTransactionId) {
                // Edit existing transaction
                const index = transactions.findIndex(t => t.id === editingTransactionId);
                if (index !== -1) {
                    transactions[index] = { ...transactions[index], ...transaction };
                }
            } else {
                // Add new transaction
                transaction.id = Date.now();
                transactions.push(transaction);
            }
            
            saveData();
            closeModal('addTransactionModal');
            document.getElementById('transactionAmount').value = '';
            renderDashboard();
        }

        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                renderDashboard();
            }
        }

        // Add category
        function addCategoryRow1() {
            document.getElementById('secondSubRow').style.display = 'block';
        }
        
        function addCategory() {
            const type = document.getElementById('newCategoryType').value;
            const mainName = document.getElementById('newCategoryName').value.trim();
            const sub1Name = document.getElementById('newSub1Name').value.trim();
            const sub1Sub2_1 = document.getElementById('newSub1Sub2_1').value.trim();
            const sub1Sub2_2 = document.getElementById('newSub1Sub2_2').value.trim();
            
            if (!mainName || !sub1Name || !sub1Sub2_1 || !sub1Sub2_2) {
                alert('Please fill in all fields for the main category and first subcategory');
                return;
            }
            
            const subcategories = [
                {
                    name: sub1Name,
                    subcategories: [sub1Sub2_1, sub1Sub2_2]
                }
            ];
            
            // Check if second subcategory row is filled
            const sub2Name = document.getElementById('newSub2Name').value.trim();
            const sub2Sub2_1 = document.getElementById('newSub2Sub2_1').value.trim();
            const sub2Sub2_2 = document.getElementById('newSub2Sub2_2').value.trim();
            
            if (sub2Name && sub2Sub2_1 && sub2Sub2_2) {
                subcategories.push({
                    name: sub2Name,
                    subcategories: [sub2Sub2_1, sub2Sub2_2]
                });
            }
            
            const newCategory = {
                name: mainName,
                subcategories: subcategories
            };
            
            if (type === 'income') {
                incomeCategories.push(newCategory);
            } else {
                expenseCategories.push(newCategory);
            }
            
            saveData();
            
            // Clear all fields
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newSub1Name').value = '';
            document.getElementById('newSub1Sub2_1').value = '';
            document.getElementById('newSub1Sub2_2').value = '';
            document.getElementById('newSub2Name').value = '';
            document.getElementById('newSub2Sub2_1').value = '';
            document.getElementById('newSub2Sub2_2').value = '';
            document.getElementById('secondSubRow').style.display = 'none';
            
            renderCategories();
        }

        // Delete category
        function deleteCategory(categoryName, type) {
            if (type === 'income') {
                incomeCategories = incomeCategories.filter(c => c.name !== categoryName);
            } else {
                expenseCategories = expenseCategories.filter(c => c.name !== categoryName);
            }
            saveData();
            renderCategories();
        }

        // Show edit category modal
        let editingSubcategories = [];
        
        function showEditCategory(categoryName, type) {
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            const category = categories.find(c => c.name === categoryName);
            
            if (!category) return;
            
            document.getElementById('editCategoryType').value = type;
            document.getElementById('editCategoryOriginalName').value = categoryName;
            document.getElementById('editCategoryName').value = category.name;
            
            // Clone the subcategories for editing
            editingSubcategories = JSON.parse(JSON.stringify(category.subcategories));
            renderEditSubcategories();
            
            document.getElementById('editCategoryModal').classList.add('active');
        }
        
        function renderEditSubcategories() {
            const container = document.getElementById('editSubcategoriesList');
            container.innerHTML = editingSubcategories.map((sub, idx) => `
                <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background: #f8fafc;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h5 style="margin: 0;">Subcategory ${idx + 1}</h5>
                        <button type="button" class="delete-btn" onclick="removeEditSubcategory(${idx})">‚úï</button>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <label style="font-size: 0.875rem; color: #64748b;">Subcategory 1 Name</label>
                        <input type="text" value="${sub.name}" onchange="updateEditSubcategoryName(${idx}, this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.875rem; color: #64748b;">Subcategory 2 Options (comma-separated)</label>
                        <input type="text" value="${sub.subcategories.join(', ')}" onchange="updateEditSubcategory2(${idx}, this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;">
                    </div>
                </div>
            `).join('');
        }
        
        function updateEditSubcategoryName(idx, value) {
            editingSubcategories[idx].name = value;
        }
        
        function updateEditSubcategory2(idx, value) {
            editingSubcategories[idx].subcategories = value.split(',').map(s => s.trim()).filter(s => s);
        }
        
        function removeEditSubcategory(idx) {
            editingSubcategories.splice(idx, 1);
            renderEditSubcategories();
        }
        
        function addEditSubcategory() {
            editingSubcategories.push({
                name: 'New Subcategory',
                subcategories: ['Option 1', 'Option 2']
            });
            renderEditSubcategories();
        }
        
        function saveEditedCategory(event) {
            event.preventDefault();
            
            const type = document.getElementById('editCategoryType').value;
            const originalName = document.getElementById('editCategoryOriginalName').value;
            const newName = document.getElementById('editCategoryName').value.trim();
            
            if (!newName) {
                alert('Category name is required');
                return;
            }
            
            // Validate subcategories
            for (let sub of editingSubcategories) {
                if (!sub.name.trim()) {
                    alert('All subcategory names are required');
                    return;
                }
                if (!sub.subcategories || sub.subcategories.length === 0) {
                    alert('Each subcategory must have at least one level 2 option');
                    return;
                }
            }
            
            const updatedCategory = {
                name: newName,
                subcategories: editingSubcategories
            };
            
            // Update the category
            const categories = type === 'income' ? incomeCategories : expenseCategories;
            const idx = categories.findIndex(c => c.name === originalName);
            
            if (idx !== -1) {
                categories[idx] = updatedCategory;
                
                // Update transactions that use this category
                if (originalName !== newName) {
                    transactions.forEach(t => {
                        if (t.category === originalName && t.type === type) {
                            t.category = newName;
                        }
                    });
                }
                
                if (type === 'income') {
                    incomeCategories = categories;
                } else {
                    expenseCategories = categories;
                }
                
                saveData();
                renderCategories();
                closeModal('editCategoryModal');
                renderDashboard(); // Refresh the dashboard to show updated category names
            }
        }

        // Render categories list
        function renderCategories() {
            const incomeList = document.getElementById('incomeCategoriesList');
            const expenseList = document.getElementById('expenseCategoriesList');
            
            const renderCategory = (cat) => {
                const subDetails = cat.subcategories.map(sub => {
                    if (typeof sub === 'object' && sub.subcategories) {
                        return `<strong>${sub.name}</strong>: ${sub.subcategories.join(', ')}`;
                    }
                    return sub;
                }).join(' | ');
                
                return subDetails;
            };
            
            incomeList.innerHTML = incomeCategories.map(cat => `
                <div class="category-item income">
                    <div>
                        <div style="font-weight: 600;">${cat.name}</div>
                        <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.25rem;">
                            ${renderCategory(cat)}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="showEditCategory('${cat.name}', 'income')" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteCategory('${cat.name}', 'income')">‚úï</button>
                    </div>
                </div>
            `).join('');
            
            expenseList.innerHTML = expenseCategories.map(cat => `
                <div class="category-item expense">
                    <div>
                        <div style="font-weight: 600;">${cat.name}</div>
                        <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.25rem;">
                            ${renderCategory(cat)}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="showEditCategory('${cat.name}', 'expense')" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteCategory('${cat.name}', 'expense')">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        // Export data
        function exportData() {
            const data = {
                transactions,
                incomeCategories,
                expenseCategories,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `profit-loss-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.transactions || !data.incomeCategories || !data.expenseCategories) {
                        alert('Invalid backup file format');
                        return;
                    }
                    if (transactions.length > 0 && !confirm('This will replace all your current data. Continue?')) {
                        return;
                    }
                    transactions = data.transactions;
                    incomeCategories = data.incomeCategories;
                    expenseCategories = data.expenseCategories;
                    saveData();
                    alert(`Successfully imported ${transactions.length} transactions!`);
                    closeModal('importExportModal');
                    renderDashboard();
                } catch (error) {
                    alert('Error importing file. Please make sure it\'s a valid backup file.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Filter functions
        function applyFilter() {
            renderDashboard();
        }

        function handlePeriodChange() {
            const period = document.getElementById('periodFilter').value;
            const monthSelector = document.getElementById('monthSelector');
            const commissionRunSelector = document.getElementById('commissionRunSelector');
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            const separator = document.getElementById('dateSeparator');
            
            // Hide all optional inputs first
            monthSelector.style.display = 'none';
            commissionRunSelector.style.display = 'none';
            startInput.style.display = 'none';
            endInput.style.display = 'none';
            separator.style.display = 'none';
            
            if (period === 'specific-month') {
                monthSelector.style.display = 'block';
                populateMonthSelector();
                // Don't show commission run until month is selected
            } else if (period === 'month') {
                // Show commission run selector for "This Month"
                commissionRunSelector.style.display = 'block';
                commissionRunSelector.value = 'whole';
            } else if (period === 'custom') {
                startInput.style.display = 'block';
                endInput.style.display = 'block';
                separator.style.display = 'block';
            }
            
            applyFilter();
        }

        function handleMonthChange() {
            const monthSelector = document.getElementById('monthSelector');
            const commissionRunSelector = document.getElementById('commissionRunSelector');
            
            // Show commission run selector when a month is selected
            if (monthSelector.value) {
                commissionRunSelector.style.display = 'block';
                commissionRunSelector.value = 'whole';
            } else {
                commissionRunSelector.style.display = 'none';
            }
            
            applyFilter();
        }

        function populateMonthSelector() {
            const select = document.getElementById('monthSelector');
            const currentDate = new Date();
            
            // Get all unique year-months from transactions
            const transactionMonths = new Set();
            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                transactionMonths.add(monthKey);
            });
            
            // Sort months in descending order (most recent first)
            const sortedMonths = Array.from(transactionMonths).sort().reverse();
            
            // Build options
            select.innerHTML = '<option value="">Select Month</option>';
            sortedMonths.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const date = new Date(year, parseInt(month) - 1);
                const monthName = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = monthName;
                select.appendChild(option);
            });
            
            // If no transactions, show last 12 months
            if (sortedMonths.length === 0) {
                for (let i = 0; i < 12; i++) {
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const monthName = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                    const option = document.createElement('option');
                    option.value = monthKey;
                    option.textContent = monthName;
                    select.appendChild(option);
                }
            }
        }

        function getFilteredTransactions() {
            const period = document.getElementById('periodFilter').value;
            const commissionRun = document.getElementById('commissionRunSelector').value;
            const now = new Date();
            let filtered = [...transactions];
            
            // Period filter
            if (period === 'month') {
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                
                if (commissionRun === 'first') {
                    // 1st to 15th
                    filtered = filtered.filter(t => {
                        const date = new Date(t.date);
                        return date >= monthStart && date <= new Date(now.getFullYear(), now.getMonth(), 15);
                    });
                } else if (commissionRun === 'second') {
                    // 16th to end of month
                    filtered = filtered.filter(t => {
                        const date = new Date(t.date);
                        return date >= new Date(now.getFullYear(), now.getMonth(), 16) && date <= monthEnd;
                    });
                } else {
                    // Whole month
                    filtered = filtered.filter(t => new Date(t.date) >= monthStart && new Date(t.date) <= monthEnd);
                }
            } else if (period === 'quarter') {
                const quarterAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                filtered = filtered.filter(t => new Date(t.date) >= quarterAgo);
            } else if (period === 'year') {
                const yearAgo = new Date(now.getFullYear(), 0, 1);
                filtered = filtered.filter(t => new Date(t.date) >= yearAgo);
            } else if (period === 'specific-month') {
                const selectedMonth = document.getElementById('monthSelector').value;
                if (selectedMonth) {
                    const [year, month] = selectedMonth.split('-');
                    const monthStart = new Date(parseInt(year), parseInt(month) - 1, 1);
                    const monthEnd = new Date(parseInt(year), parseInt(month), 0);
                    
                    if (commissionRun === 'first') {
                        // 1st to 15th
                        filtered = filtered.filter(t => {
                            const date = new Date(t.date);
                            return date >= monthStart && date <= new Date(parseInt(year), parseInt(month) - 1, 15);
                        });
                    } else if (commissionRun === 'second') {
                        // 16th to end of month
                        filtered = filtered.filter(t => {
                            const date = new Date(t.date);
                            return date >= new Date(parseInt(year), parseInt(month) - 1, 16) && date <= monthEnd;
                        });
                    } else {
                        // Whole month
                        filtered = filtered.filter(t => {
                            const date = new Date(t.date);
                            return date.getFullYear() === parseInt(year) && 
                                   (date.getMonth() + 1) === parseInt(month);
                        });
                    }
                }
            } else if (period === 'custom') {
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                if (start && end) {
                    filtered = filtered.filter(t => t.date >= start && t.date <= end);
                }
            }
            
            // Advanced filters
            const filterType = document.getElementById('filterType').value;
            const filterCategory = document.getElementById('filterCategory').value;
            const filterSubcategory1 = document.getElementById('filterSubcategory1').value;
            const filterSubcategory2 = document.getElementById('filterSubcategory2').value;
            const filterAdvisor = document.getElementById('filterAdvisor').value;
            
            if (filterType !== 'all') {
                filtered = filtered.filter(t => t.type === filterType);
            }
            
            if (filterCategory !== 'all') {
                filtered = filtered.filter(t => t.category === filterCategory);
            }
            
            if (filterSubcategory1 !== 'all') {
                filtered = filtered.filter(t => t.subcategory1 === filterSubcategory1 || t.subcategory === filterSubcategory1);
            }
            
            if (filterSubcategory2 !== 'all') {
                filtered = filtered.filter(t => t.subcategory2 === filterSubcategory2);
            }
            
            if (filterAdvisor !== 'all') {
                filtered = filtered.filter(t => t.advisor === filterAdvisor);
            }
            
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Render dashboard
        function renderDashboard() {
            const filtered = getFilteredTransactions();
            
            // Calculate totals - properly handle negative amounts
            const totalIncome = filtered.filter(t => t.type === 'income').reduce((sum, t) => {
                // For income, negative amounts should subtract from total
                return sum + t.amount;
            }, 0);
            
            const totalExpenses = filtered.filter(t => t.type === 'expense').reduce((sum, t) => {
                // Expenses are always treated as positive for the total
                return sum + Math.abs(t.amount);
            }, 0);
            
            const netProfit = totalIncome - totalExpenses;
            
            // Update stats
            document.getElementById('totalIncome').textContent = '$' + totalIncome.toLocaleString();
            document.getElementById('totalExpenses').textContent = '$' + totalExpenses.toLocaleString();
            document.getElementById('netProfit').textContent = (netProfit >= 0 ? '+' : '') + netProfit.toLocaleString('en-US', {style: 'currency', currency: 'USD'});
            document.getElementById('netProfit').className = 'stat-value ' + (netProfit >= 0 ? 'profit' : 'loss');
            document.getElementById('profitCard').className = 'stat-card ' + (netProfit >= 0 ? 'profit' : 'loss');
            
            // Prepare monthly data
            const monthlyMap = {};
            filtered.forEach(t => {
                const date = new Date(t.date);
                const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyMap[month]) {
                    monthlyMap[month] = { income: 0, expenses: 0 };
                }
                if (t.type === 'income') {
                    // Income can be positive or negative
                    monthlyMap[month].income += t.amount;
                } else {
                    // Expenses are always positive for the chart
                    monthlyMap[month].expenses += Math.abs(t.amount);
                }
            });
            
            const monthlyData = Object.keys(monthlyMap).sort().map(month => ({
                month,
                income: monthlyMap[month].income,
                expenses: monthlyMap[month].expenses,
                profit: monthlyMap[month].income - monthlyMap[month].expenses
            }));
            
            // Update charts
            updateCharts(monthlyData);
            
            // Update breakdowns
            updateBreakdowns(filtered);
            
            // Update transactions table
            updateTransactionsTable(filtered);
        }

        // Update charts
        function updateCharts(monthlyData) {
            // Monthly trend chart
            if (charts.monthly) charts.monthly.destroy();
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: monthlyData.map(d => d.month),
                    datasets: [
                        {
                            label: 'Income',
                            data: monthlyData.map(d => d.income),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Expenses',
                            data: monthlyData.map(d => d.expenses),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Profit',
                            data: monthlyData.map(d => d.profit),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
            
            // Comparison chart
            if (charts.comparison) charts.comparison.destroy();
            const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
            charts.comparison = new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: monthlyData.map(d => d.month),
                    datasets: [
                        {
                            label: 'Income',
                            data: monthlyData.map(d => d.income),
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Expenses',
                            data: monthlyData.map(d => d.expenses),
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Update breakdowns
        function updateBreakdowns(filtered) {
            const incomeByCategory = {};
            const expensesByCategory = {};
            
            filtered.forEach(t => {
                if (t.type === 'income') {
                    incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + t.amount;
                } else {
                    expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                }
            });
            
            const incomeBreakdown = document.getElementById('incomeBreakdown');
            incomeBreakdown.innerHTML = Object.keys(incomeByCategory).length > 0
                ? Object.entries(incomeByCategory).map(([cat, amt]) => `
                    <div class="breakdown-item income">
                        <span class="name">${cat}</span>
                        <span class="value">$${amt.toLocaleString()}</span>
                    </div>
                `).join('')
                : '<p class="empty-state">No income transactions yet</p>';
            
            const expenseBreakdown = document.getElementById('expenseBreakdown');
            expenseBreakdown.innerHTML = Object.keys(expensesByCategory).length > 0
                ? Object.entries(expensesByCategory).map(([cat, amt]) => `
                    <div class="breakdown-item expense">
                        <span class="name">${cat}</span>
                        <span class="value">$${amt.toLocaleString()}</span>
                    </div>
                `).join('')
                : '<p class="empty-state">No expense transactions yet</p>';
        }

        // Update transactions table
        function updateTransactionsTable(filtered) {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = filtered.length > 0
                ? filtered.slice(0, 10).map(t => {
                    // Determine color: green for positive income, red for everything else
                    const isPositiveIncome = t.type === 'income' && t.amount >= 0;
                    const amountColor = isPositiveIncome ? '#10b981' : '#ef4444';
                    const recurringBadge = t.isRecurring ? '<span style="background: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: 0.5rem;">üîÅ Recurring</span>' : '';
                    
                    return `
                    <tr>
                        <td>${t.date}${recurringBadge}</td>
                        <td><span class="badge ${t.type}">${t.type === 'income' ? 'Income' : 'Expense'}</span></td>
                        <td>
                            <div style="font-weight: 500;">${t.category}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">${t.subcategory1 || t.subcategory || 'General'}</div>
                        </td>
                        <td>
                            <div>${t.subcategory2 || 'Type A'}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">üë§ ${t.advisor || 'Unassigned'}</div>
                        </td>
                        <td style="text-align: right; font-weight: bold; color: ${amountColor};">
                            ${t.type === 'income' ? '+' : '-'}$${Math.abs(t.amount).toLocaleString()}
                        </td>
                        <td style="text-align: right;">
                            <button class="btn btn-secondary" onclick="duplicateTransaction(${t.id})" style="padding: 0.25rem 0.5rem; font-size: 0.875rem; margin-right: 0.25rem;" title="Duplicate">
                                üìã
                            </button>
                            <button class="btn btn-primary" onclick="showEditTransaction(${t.id})" style="padding: 0.25rem 0.5rem; font-size: 0.875rem; margin-right: 0.25rem;" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button class="delete-btn" onclick="deleteTransaction(${t.id})" title="Delete">‚úï</button>
                        </td>
                    </tr>
                `;
                }).join('')
                : '<tr><td colspan="6" class="empty-state">No transactions yet. Add your first transaction to get started!</td></tr>';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            try {
                loadData();
                processRecurringTransactions(); // Process any due recurring transactions
                if (document.getElementById('filterType')) {
                    updateFilterMainCategories();
                    updateFilterAdvisors();
                }
                renderDashboard();
            } catch (error) {
                console.error('Initialization error:', error);
                // Still try to render dashboard even if filters fail
                try {
                    renderDashboard();
                } catch (e) {
                    console.error('Dashboard render error:', e);
                }
            }
        });
    </script>
</body>
</html>
